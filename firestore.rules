service cloud.firestore {


// Check if the request is authenticated
function isAuthenticated() {
  return request.auth != null;
}

  match /databases/{database}/documents {
  // admin functions
    function isSKAdmin() {
  		return exists(/databases/$(database)/documents/skAdmins/$(request.auth.uid)) ;
		}

		// THE FULL DATABASE
    match /{document=**} {
      allow read, write : if fasle ;

    }
      //skAdmins
			match /skAdmins/{admin=**} {

        function isSKAdminAdmin() {
        		return get(/databases/$(database)/documents/skAdmins/$(request.auth.uid)).isSkAdmin == true ||
        		       get(/databases/$(database)/documents/skAdmins/$(request.auth.uid)).data.isSkAdmin == true ;
    		}

        function isSKAdminEditor() {
        		return get(/databases/$(database)/documents/skAdmins/$(request.auth.uid)).isSkEditor == true ||
        		       get(/databases/$(database)/documents/skAdmins/$(request.auth.uid)).data.isSkEditor == true ;
    		}
      	allow read: if true;
        allow write: if isSKAdminAdmin() ;
      }
		//Data Packages
			match /dataPackages/{datapackage=**} {
      	allow read: if true;
        allow write: if isSKAdminEditor();
      }
    	//OrgRequested
			match /orgRequested/{id=**} {
      	allow read: if true;
        allow write: if true;
      }

		//users
			match /users/{user=**} {
      	allow read: if true;
        allow write: if true;
      }


    // ORG
    match /org {

      match /{orgId}{
          function isSKAdminAdmin() {
              return get(/databases/$(database)/documents/skAdmins/$(request.auth.uid)).isSkAdmin == true ||
                    get(/databases/$(database)/documents/skAdmins/$(request.auth.uid)).data.isSkAdmin == true ;
          }

          function isOrgExists(org) {
    					return  exists(/databases/$(database)/documents/org/$(org)/publicData/info)
    			}
          function getRole(role) {
        		return get(/databases/$(database)/documents/org/$(orgId)/users/$(request.auth.uid)).data.roles[role] == true ||
        		       get(/databases/$(database)/documents/org/$(orgId)/users/$(request.auth.uid)).roles[role] == true ;
    			}

      		allow read: if getRole('admin') || getRole('editor') || getRole('viewer') || isSKAdminAdmin();
   				allow write: if getRole('admin') || getRole('editor') || isSKAdminAdmin()  ;

          match /publicData/{allPublicData=**}{
          		allow read: if true ;
              allow write: if getRole('admin')  || isSKAdminAdmin();
          }

          match /docsAcks/{docAck=**}{
          		allow read: if getRole('admin') || getRole('editor') || getRole('viewer');
              allow write: if getRole('editor')  || isSKAdminAdmin();
          }

          match /users/{user=**} {
          		allow read : if true;
              allow write : if  (isOrgExists(orgId)
              							&& (request.resource.data.roles.keys().hasAny(['admin', 'editor', 'viewer']) == false || getRole('admin')))
                             || isSKAdminAdmin();
          }

          match /docs/{docs=**} {
            allow read : if getRole('admin') || getRole('editor') || getRole('viewer');
            allow write : if getRole('editor')  || isSKAdminAdmin();
          }
          match /invites/{invite=**}{
          		allow read : if true ;
              allow write: if getRole('admin') || isSKAdminAdmin();
          }
  		}
    }
	}
}
